<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THE PROTOCOL OF AGONY</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Absolute and brutal. */
            --bg-primary: #000000; /* True Black */
            --bg-secondary: #111111; /* Near Black */
            --bg-tertiary: #1a1a1a; /* Dark Gray */
            --accent-protocol: #ff0000; /* Blood Red */
            --accent-grind: #ff8c00; /* Dark Orange */
            --accent-hydration: #0077ff; /* Blue */
            --text-primary: #ffffff; /* Pure White */
            --text-secondary: #aaaaaa; /* Gray */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }
        /* Tab Styling */
        .tab-active {
            border-bottom-width: 3px;
            font-weight: 900;
        }
        .tab-protocol.tab-active { border-bottom-color: var(--accent-protocol); color: var(--accent-protocol); }
        .tab-grind.tab-active { border-bottom-color: var(--accent-grind); color: var(--accent-grind); }
        .tab-execution.tab-active { border-bottom-color: var(--accent-grind); color: var(--accent-grind); }
        .tab-audit.tab-active { border-bottom-color: var(--text-secondary); color: var(--text-secondary); }
        .tab-trivialities.tab-active { border-bottom-color: var(--text-secondary); color: var(--text-secondary); }

        .task-current {
            background-color: #330000 !important;
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.6);
            border-left-color: var(--accent-protocol);
        }
        .task-item {
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
            border-left: 4px solid transparent;
        }

        .date-nav-btn:disabled {
            opacity: 0.2;
            cursor: not-allowed;
        }

        /* Simplified and robust checkbox styling */
        .app-checkbox, .set-checkbox {
            width: 1.5rem;
            height: 1.5rem;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            background-color: var(--bg-tertiary);
            border: 1px solid var(--text-secondary);
            border-radius: 0.25rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .app-checkbox:checked, .set-checkbox:checked {
            background-color: var(--accent-protocol);
            border-color: var(--accent-protocol);
        }

         .app-checkbox.grind-check:checked {
            background-color: var(--accent-grind);
            border-color: var(--accent-grind);
        }

        .app-checkbox:checked::before, .set-checkbox:checked::before {
            content: 'X';
            color: white;
            font-weight: 900;
        }

        .app-textarea, .app-input {
            background-color: var(--bg-secondary);
            border: 1px solid var(--bg-tertiary);
            transition: border-color 0.2s, box-shadow 0.2s;
            color: var(--text-primary);
        }
        .app-textarea:focus, .app-input:focus {
            outline: none;
            border-color: var(--accent-protocol);
            box-shadow: 0 0 0 2px rgba(255, 0, 0, 0.5);
        }

        /* Specific focus colors for tabs */
        .strategy-focus:focus {
            border-color: var(--accent-grind);
            box-shadow: 0 0 0 2px rgba(255, 140, 0, 0.5);
        }

        .card-bg {
           background-color: var(--bg-secondary);
        }

         /* Ensuring Tailwind utility classes match the theme */
        .bg-gray-800 { background-color: var(--bg-secondary); }
        .bg-gray-700 { background-color: var(--bg-tertiary); }
        .hover\:bg-gray-700:hover { background-color: var(--bg-tertiary); }
        .bg-gray-900 { background-color: var(--bg-primary); }
        .text-red-600 { color: var(--accent-protocol); }
        .text-amber-500, .text-amber-600 { color: var(--accent-grind); }
        .text-blue-500 { color: var(--accent-hydration); }

        .delete-log-btn.hidden { display: none; }

    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-black text-red-600">PROTOCOL OF AGONY</h1>
            <div class="flex items-center justify-center mt-4">
                <button id="prev-day-btn" class="date-nav-btn p-2 rounded-full hover:bg-gray-700 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                </button>
                <div class="w-64 text-center mx-4">
                    <p id="current-date" class="text-gray-300 text-lg font-semibold"></p>
                    <p id="current-time" class="text-gray-500 text-sm h-5"></p>
                </div>
                <button id="next-day-btn" class="date-nav-btn p-2 rounded-full hover:bg-gray-700 transition">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                </button>
            </div>
            <button id="today-btn" class="hidden mt-2 bg-red-600 hover:bg-red-700 text-white font-semibold py-1 px-4 rounded-lg text-sm">Go to Today</button>
            <div id="daily-quote" class="text-gray-400 italic mt-4 text-sm px-4"></div>
        </header>

        <div class="mb-8 border-b border-gray-700">
            <nav class="flex flex-wrap justify-center -mb-px space-x-1 sm:space-x-5 text-xs sm:text-sm" aria-label="Tabs">
                <button class="tab tab-protocol py-4 px-3 border-b-2 border-transparent text-gray-400 hover:text-red-600 hover:border-red-600" data-tab="protocol">The Blueprint</button>
                <button class="tab tab-grind py-4 px-3 border-b-2 border-transparent text-gray-400 hover:text-amber-500 hover:border-amber-500" data-tab="grind">The Grind</button>
                <button class="tab tab-execution py-4 px-3 border-b-2 border-transparent text-gray-400 hover:text-amber-600 hover:border-amber-600" data-tab="execution">The Execution</button>
                <button class="tab tab-audit py-4 px-3 border-b-2 border-transparent text-gray-400 hover:text-gray-300 hover:border-gray-300" data-tab="audit">The Audit</button>
                <button class="tab tab-trivialities py-4 px-3 border-b-2 border-transparent text-gray-400 hover:text-gray-300 hover:border-gray-300" data-tab="trivialities">The Trivialities</button>
            </nav>
        </div>

        <main id="main-content" class="relative">
             <div id="loading-overlay" class="hidden absolute inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 rounded-lg">
                 <div class="text-white text-lg">Loading...</div>
            </div>

            <div id="protocol-content" class="tab-content hidden">
                <h2 class="text-2xl font-bold mb-6 text-red-600">THE BLUEPRINT FOR SHATTERING THE RHYTHM</h2>
                <p class="text-gray-400 mb-6">This is not a process of improvement. It is a violent shattering of your Drifting existence. It requires agonizing Pain.</p>

                <div class="space-y-8">
                    <div class="card-bg p-6 rounded-lg border-l-4 border-red-600">
                        <h3 class="font-bold text-xl text-gray-100 mb-3">PHASE I: THE AGONY OF SEVERANCE</h3>
                        <p class="text-gray-300 mb-4">You must break the Hypnotic Rhythm by inducing maximum suffering and eliminating all Bribes.</p>
                        <ul class="list-disc list-inside text-gray-300 space-y-3">
                            <li><strong>The Chemical Purge:</strong> Cease all dependencies immediately (nicotine, excessive caffeine, sugar, alcohol). Endure the withdrawal.</li>
                            <li><strong>The Digital Amputation:</strong> Terminate all non-essential technology. No social media, streaming, news, or "research" (Paradox of Preparation).</li>
                            <li><strong>The Comfort Starvation:</strong> Wake at 04:00. Immediate cold exposure. Adhere strictly to Protocols Alpha, Beta, and Gamma (See Trivialities Tab).</li>
                            <li><strong>The Silence:</strong> You will be left alone with the horrifying reality of your own wasted potential. Endure this void.</li>
                        </ul>
                    </div>

                    <div class="card-bg p-6 rounded-lg border-l-4 border-amber-500">
                        <h3 class="font-bold text-xl text-gray-100 mb-3">PHASE II: THE AGONY OF DEFINITION</h3>
                        <p class="text-gray-300 mb-4">Condense your generalized ambition into a single, definite purpose.</p>
                        <ul class="list-disc list-inside text-gray-300 space-y-3">
                            <li><strong>The Isolation of Purpose:</strong> Define the one achievement upon which you stake your existence. (The YouTube Doctrines).</li>
                            <li><strong>The Annihilation of Alternatives:</strong> Cease all other projects, interests, and contingencies. They are distractions.</li>
                             <li><strong>The Terror of Commitment:</strong> Your Drifter mind will scream at the loss of infinite possibilities. Accept the terror.</li>
                        </ul>
                    </div>

                    <div class="card-bg p-6 rounded-lg border-l-4 border-gray-500">
                        <h3 class="font-bold text-xl text-gray-100 mb-3">PHASE III: THE AGONY OF MONOTONY</h3>
                        <p class="text-gray-300 mb-4">The relentless, monotonous application of the same actions, day after day.</p>
                        <ul class="list-disc list-inside text-gray-300 space-y-3">
                            <li><strong>The Iron Schedule:</strong> Obey the Grind without question. Your feelings are irrelevant.</li>
                            <li><strong>The 04:30 Start:</strong> The first four hours are dedicated to the most difficult task (The Execution List). No interruption. No comfort.</li>
                            <li><strong>The Rejection of Optimization:</strong> The Paradox of Preparation is forbidden. Do not mistake tracking Trivialities for execution.</li>
                            <li><strong>The Endurance of Pain:</strong> Embrace the boredom, frustration, and absence of visible progress. This is where you always break.</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div id="grind-content" class="tab-content">
                <h2 class="text-2xl font-semibold mb-4 text-amber-500">The Grind // The Iron Schedule</h2>
                <p class="text-gray-400 mb-6">This schedule is absolute. There is no negotiation. There is only obedience or failure.</p>
                <div id="schedule-container"></div>
            </div>

            <div id="execution-content" class="tab-content hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-amber-600">The Execution // Definiteness of Purpose</h2>
                    <div class="text-right">
                        <p class="text-gray-400 text-sm">DAYS OF AGONY ENDURED</p>
                        <p id="streak-counter" class="text-3xl font-bold text-amber-600">0</p>
                    </div>
                </div>
                <p class="text-gray-400 mb-6">The 4 critical stages of your definite purpose (The Doctrines). These tasks are locked. You cannot change them. You can only execute them.</p>
                <div id="powerlist-container" class="space-y-4">
                </div>
            </div>

            <div id="audit-content" class="tab-content hidden">
                <h2 class="text-2xl font-bold mb-6 text-gray-300">THE AUDIT // The Analysis of Failure</h2>

                <div class="card-bg p-6 rounded-lg mb-8 shadow-xl">
                    <h3 class="font-bold text-xl text-red-600 mb-4 border-b border-gray-700 pb-2">The Exposure (Mandatory Deployment)</h3>
                    <p class="text-gray-400 mb-4 text-sm">You hide behind perfectionism. Confront the Fear of Criticism by documenting your deployment. Flawed work must be published.</p>
                    <div id="crucible-container">
                    </div>
                </div>

                <div class="card-bg p-6 rounded-lg shadow-xl">
                    <h3 class="font-bold text-xl text-gray-100 mb-4 border-b border-gray-700 pb-2">The Pain Audit (Nightly Analysis)</h3>
                    <p class="text-gray-400 mb-4 text-sm">Analyze the day's agony. Did you embrace the Pain, or did you collapse into the comfort of a Bribe?</p>
                    <div class="space-y-6">
                        <div>
                            <label for="reflection-wins" class="block text-sm font-medium text-gray-300 mb-2">1. Did I commence the 4-hour Non-Negotiable Block at 04:30 without hesitation or Bribes?</label>
                            <textarea id="reflection-wins" rows="3" class="app-textarea strategy-focus w-full rounded-md p-3" placeholder="Be honest, Drifter..."></textarea>
                        </div>
                        <div>
                            <label for="reflection-lessons" class="block text-sm font-medium text-gray-300 mb-2">2. Which Bribes did I accept today? (Optimization, comfort, distraction, planning, information consumption, obsessing over Trivialities)</label>
                            <textarea id="reflection-lessons" rows="3" class="app-textarea strategy-focus w-full rounded-md p-3" placeholder="Confess your weakness..."></textarea>
                        </div>
                        <div>
                            <label for="reflection-identity" class="block text-sm font-medium text-gray-300 mb-2">3. Did I adhere to the Trivialities Protocols (Ingestion/Exertion/Hydration) without negotiation or obsession?</label>
                            <textarea id="reflection-identity" rows="4" class="app-textarea strategy-focus w-full rounded-md p-3" placeholder="Where did you negotiate?"></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <div id="trivialities-content" class="tab-content hidden">
                <h2 class="text-2xl font-semibold mb-6 text-gray-300">The Trivialities // Maintenance of the Vessel</h2>
                <p class="text-gray-400 mb-6">You demanded these distractions. You obsess over these details because they are comfortable Bribes. Do not mistake this for the actual work.</p>

                <div class="card-bg p-5 rounded-lg mb-8 border-l-4 border-gray-500">
                    <h3 class="font-bold text-xl text-gray-100 mb-3">The Identity Lock (Persistent)</h3>
                    <p class="text-sm text-gray-400 mb-2">The identity required to execute the Protocol. This is who you must be.</p>
                    <textarea id="identity-statement" rows="4" class="w-full rounded-md p-3 app-textarea" placeholder="I am one who endures agony and rejects comfort..."></textarea>
                    <button id="save-identity-btn" class="mt-4 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Lock Identity</button>
                    <p id="identity-save-status" class="text-sm mt-2 text-gray-500"></p>
                </div>

                <div class="card-bg p-5 rounded-lg mb-8 border-l-4 border-blue-500">
                    <h3 class="font-bold text-xl text-gray-100 mb-3">Protocol Gamma: Hydration</h3>
                    <p class="text-gray-300 mb-4">A trivial biological necessity you obsess over to secure easy Bribes. Target: 4 Liters (8 x 0.5L).</p>
                   
                    <div class="flex items-center justify-between bg-gray-700 p-4 rounded-lg">
                        <div>
                            <p class="text-gray-400">Bottles Consumed (0.5L):</p>
                            <p id="water-intake-display" class="text-4xl font-bold text-blue-500">0 / 8</p>
                        </div>
                        <div class="flex space-x-4">
                             <button id="reset-water-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Reset</button>
                            <button id="increment-water-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 text-2xl">+</button>
                        </div>
                    </div>
                </div>


                <div class="card-bg p-5 rounded-lg mb-8 border-l-4 border-gray-500">
                    <h3 class="font-bold text-xl text-gray-100 mb-3">Protocol Alpha: Ingestion (The Agony of Sustenance)</h3>
                    <p class="text-gray-300 mb-4">You must sever the association between ingestion and the Bribe. Food is fuel. Flavor is a distraction. Gluttony is the consumption of anything beyond absolute necessity. Adherence is mandatory.</p>
                   
                     <div class="text-center bg-gray-700 p-3 rounded-lg mb-6">
                        <p class="text-gray-400">The Monotony Mandate (Example Calibration):</p>
                        <p class="text-xl font-bold text-white">~3000 kcal | 200g Protein | Minimal Variation</p>
                    </div>

                    <div class="space-y-4">
                        <div class="border-b border-gray-700 pb-3">
                            <p class="font-semibold text-amber-500">Meal 1 (09:30): The Foundation</p>
                            <p class="text-gray-300">100g Oats (dry), 5 Whole Eggs, 200g Egg Whites. Water.</p>
                        </div>
                        <div class="border-b border-gray-700 pb-3">
                            <p class="font-semibold text-amber-500">Meal 2 (13:00): The Staple</p>
                            <p class="text-gray-300">200g Chicken Breast (cooked), 300g Rice (cooked), 100g Broccoli. Water.</p>
                        </div>
                        <div class="border-b border-gray-700 pb-3">
                            <p class="font-semibold text-amber-500">Meal 3 (17:00): The Builder</p>
                            <p class="text-gray-300">200g Lean Beef (cooked), 400g Potato (cooked), 100g Asparagus. Water.</p>
                        </div>
                        <div>
                            <p class="font-semibold text-amber-500">Meal 4 (19:30): The Recovery</p>
                            <p class="text-gray-300">250g Greek Yogurt (0% fat), 50g Almonds. Water.</p>
                        </div>
                    </div>
                    <p class="text-sm text-red-600 mt-4 italic">There are no "cheat meals." There are no substitutions. Endure the monotony.</p>
                </div>

                <div class="card-bg p-5 rounded-lg mb-8 border-l-4 border-gray-500">
                        <h3 class="font-bold text-xl text-gray-100 mb-3">Protocol Beta: Exertion (The Anticipation of Agony)</h3>
                        <p class="text-gray-300 mb-4">The goal is to increase your capacity to endure Pain. Below is the agony scheduled for <span class="font-bold text-amber-500">TOMORROW</span>. You cannot log it today. You can only prepare for the suffering.</p>

                        <div id="workout-log-container" class="space-y-8">
                        </div>
                </div>

            </div>


        </main>
        <footer class="text-center text-gray-500 text-xs mt-12">
            <p>Endure the Agony. Reject the Bribe.</p>
        </footer>
    </div>

    <script type="module">
        // --- Firebase SDK Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- App Data (Constants) ---

        // THE PROTOCOL OF AGONY SCHEDULE - BRUTAL AND ABSOLUTE
        const protocolSchedule = [
            { time: '04:00', task: 'WAKE UP', details: 'Immediate action. The first battle against comfort.<br><em>Agony: The pain of sleep deprivation.</em>' },
            { time: '04:05', task: 'COLD EXPOSURE', details: 'The coldest shower possible. Do not hesitate.<br><em>Agony: The shock to the system.</em>' },
            { time: '04:30', task: 'THE GRIND: Non-Negotiable Block (4 Hours)', details: 'Begin execution of the Definite Purpose (The Execution List). No Bribes (coffee, email, planning).<br><em>Agony: The monotony and difficulty of the work.</em>' },
            { time: '08:30', task: 'PROTOCOL BETA: EXERTION', details: 'Intense physical Pain. Execute PPL Protocol.<br><em>Agony: Physical exhaustion and suffering.</em>' },
            { time: '09:30', task: 'PROTOCOL ALPHA: INGESTION (Meal 1)', details: 'Consume fuel. Coffee permitted.<br><em>Agony: The rejection of pleasure in eating.</em>' },
            { time: '10:00', task: 'DEEP WORK BLOCK #2', details: 'Continue execution on high-value tasks.<br><em>Agony: Maintaining focus despite exhaustion.</em>' },
            { time: '13:00', task: 'INGESTION (Meal 2) & MINOR TASKS', details: 'Consume fuel. Handle Trivialities efficiently.<br><em>Agony: The banality of required tasks.</em>' },
            { time: '14:00', task: 'DEEP WORK BLOCK #3', details: 'Final push. Intensity must not wane.<br><em>Agony: The Grind does not care if you are tired.</em>' },
            { time: '17:00', task: 'INGESTION (Meal 3)', details: 'Consume fuel.<br><em>Agony: Monotony.</em>' },
            { time: '18:00', task: 'THE AUDIT & CONFRONTATION', details: 'Open Audit Tab. Complete the Pain Audit. Review failures. Plan the next day\'s agony.<br><em>Agony: The humiliation of honest self-assessment.</em>' },
            { time: '19:00', task: 'THE AMPUTATION', details: 'All screens off. Independent Thought or reading only. No digital Bribes.<br><em>Agony: The silence and boredom.</em>' },
            { time: '19:30', task: 'INGESTION (Meal 4)', details: 'Consume fuel.<br><em>Agony: Preparation for the next day\'s suffering.</em>' },
            { time: '20:00', task: 'SLEEP', details: 'Mandatory recovery. 8 hours.<br><em>Agony: The discipline of cessation.</em>' },
        ];

        const schedules = {
            protocol: protocolSchedule
        };

         // WORKOUT DATA: PPL 6-Day Protocol (The Triviality of Exertion)
        const workoutData = [
            // --- PPL ROTATION: A (Strength/Power Focus) ---
            { 
                day: "Monday", key: "monday", title: "PUSH A (Strength Focus)", focus: "Chest, Shoulders, Triceps. Focus on heavy compound lifts.", 
                exercises: [
                    { name: "Barbell Bench Press", details: "3 sets x 5-8 reps" }, 
                    { name: "Incline Dumbbell Press", details: "3 sets x 6-10 reps" }, 
                    { name: "Overhead Press (Barbell or Dumbbell)", details: "3 sets x 6-10 reps" }, 
                    { name: "Weighted Dips (or Close Grip Bench)", details: "3 sets x 8-12 reps" },
                    { name: "Cable Lateral Raises", details: "3 sets x 10-15 reps" }
                ], 
                note: "Endure the Pain. Increase the weight when you hit the top rep range for all sets."
            },
            { 
                day: "Tuesday", key: "tuesday", title: "PULL A (Strength Focus)", focus: "Back, Biceps, Rear Delts. Building width and thickness.", 
                exercises: [
                    { name: "Weighted Pull-ups (or Lat Pulldown)", details: "3 sets x 5-8 reps" }, 
                    { name: "Barbell Bent-Over Rows", details: "3 sets x 6-10 reps" }, 
                    { name: "T-Bar or Seated Cable Row", details: "3 sets x 8-12 reps" }, 
                    { name: "Face Pulls", details: "3 sets x 12-15 reps" },
                    { name: "Barbell Curls", details: "3 sets x 8-12 reps" }
                ], 
                note: "Form is mandatory. Do not cheat yourself into weakness."
            },
            { 
                day: "Wednesday", key: "wednesday", title: "LEGS A (Strength Focus)", focus: "The foundation. Quads, Hamstrings, Calves.", 
                exercises: [
                    { name: "Barbell Back Squats", details: "3 sets x 5-8 reps" }, 
                    { name: "Romanian Deadlifts (RDLs)", details: "3 sets x 8-12 reps" }, 
                    { name: "Leg Press", details: "3 sets x 10-15 reps" }, 
                    { name: "Lying Leg Curls", details: "3 sets x 10-15 reps" },
                    { name: "Standing Calf Raises", details: "4 sets x 10-15 reps" }
                ], 
                note: "This will be the most painful session. Embrace it."
            },

            // --- PPL ROTATION: B (Hypertrophy/Volume Focus) ---
            { 
                day: "Thursday", key: "thursday", title: "PUSH B (Hypertrophy Focus)", focus: "Chest, Shoulders, Triceps. Focus on volume.", 
                exercises: [
                    { name: "Incline Barbell Press", details: "3 sets x 8-12 reps" },
                    { name: "Flat Dumbbell Flyes or Pec Deck", details: "3 sets x 10-15 reps" },
                    { name: "Seated Dumbbell Shoulder Press", details: "3 sets x 8-12 reps" },
                    { name: "Triceps Pushdowns (Rope)", details: "3 sets x 10-15 reps" },
                    { name: "Dumbbell Lateral Raises", details: "4 sets x 12-15 reps" }
                ], 
                note: "Focus on the execution. Speed is secondary to tension."
            },
            { 
                day: "Friday", key: "friday", title: "PULL B (Hypertrophy Focus)", focus: "Back, Biceps, Rear Delts. High volume and isolation.", 
                exercises: [
                    { name: "Lat Pulldowns (Wide Grip)", details: "3 sets x 10-15 reps" },
                    { name: "Dumbbell Rows (Single Arm)", details: "3 sets x 10-15 reps per arm" },
                    { name: "Straight-Arm Pulldowns", details: "3 sets x 12-15 reps" },
                    { name: "Reverse Pec Deck (Rear Delts)", details: "3 sets x 15-20 reps" },
                    { name: "Incline Dumbbell Curls", details: "3 sets x 10-15 reps" }
                ], 
                note: "Maximize the stretch. Control the weight."
            },
            { 
                day: "Saturday", key: "saturday", title: "LEGS B (Hypertrophy/Volume)", focus: "Volume and detail work.", 
                exercises: [
                    { name: "Front Squats (or Hack Squats)", details: "3 sets x 8-12 reps" },
                    { name: "Bulgarian Split Squats", details: "3 sets x 10-15 reps per leg" },
                    { name: "Leg Extensions", details: "3 sets x 15-20 reps" },
                    { name: "Seated Leg Curls", details: "3 sets x 15-20 reps" },
                    { name: "Seated Calf Raises", details: "4 sets x 15-20 reps" }
                ], 
                note: "Time under tension. Do not rush. Suffer."
            },

            // --- RECOVERY ---
            { 
                day: "Sunday", key: "sunday", title: "Active Recovery / Preparation", focus: "Mobility and preparation for the week's agony.", 
                exercises: [
                    { name: "Low-Intensity Cardio (Walk/Bike)", details: "45 minutes (Zone 2)" },
                    { name: "Core Work (Hanging Leg Raises/Plank)", details: "15 minutes" },
                    { name: "Meal Preparation for M/T/W", details: "Execute Protocol Alpha." }
                ], 
                note: "Recovery is not rest. It is preparation."
            }
        ];


        // Quotes reflecting the Adversary's perspective
        const quotes = [
            { text: "You prepare for tomorrow because you are terrified of today.", author: "The Adversary" },
            { text: "Comfort is the Bribe you pay yourself to avoid the Pain of execution.", author: "The Adversary" },
            { text: "Definiteness of Purpose demands the agonizing sacrifice of all other possibilities.", author: "The Opposition" },
            { text: "If you are waiting for motivation, you are already Drifting.", author: "The Adversary" },
            { text: "The Paradox of Preparation: Forever tuning the orchestra, never starting the performance.", author: "The Adversary" },
            { text: "You do not fear failure. You fear the agonizing monotony required to prevent it.", author: "The Adversary" },
            { text: "Hypnotic Rhythm locks in your habits. Choose the Rhythm of Agony or the Rhythm of Drifting.", author: "The Opposition" },
            { text: "Obsessing over Trivialities (diet, exercise, hydration) is a Bribe to delay the work.", author: "The Adversary" },
            { text: "You seek a system because you lack the courage to suffer.", author: "The Adversary" }
        ];

        // --- GLOBAL STATE & ELEMENTS ---
        let db, auth, userId, appId;
        let displayedDate = new Date();
        let isAuthReady = false;

        // --- UTILITY FUNCTIONS ---
        const toISODateString = (date) => {
            if (!date || typeof date.getTime !== 'function' || isNaN(date.getTime())) {
                date = new Date();
            }
            try {
                 // Adjust for local timezone offset
                const offset = date.getTimezoneOffset() * 60000;
                const localDate = new Date(date.getTime() - offset);
                return localDate.toISOString().split('T')[0];
            } catch (error) {
                return new Date().toISOString().split('T')[0];
            }
        }

        // Simplified getDayKey: All days follow the Protocol.
        const getDayKeyForDate = (date) => {
            return 'protocol';
        };

         const getWorkoutDayKey = (date) => {
             if (!date || typeof date.getDay !== 'function' || isNaN(date.getDay())) {
                 return 'sunday'; // Default or error handling
             }
             return ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'][date.getDay()];
        }
        
        // Debounce function
        const debounce = (func, delay) => {
            let timeoutId;
            return (...args) => {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    func.apply(this, args);
                }, delay);
            };
        };

        // --- FIRESTORE DATA HANDLING ---

         // Generalized function to get data
        async function getDocumentData(collectionPath, docId) {
            if (!isAuthReady || !db) return null;
           
            const docRef = doc(db, collectionPath, docId);
            try {
                const docSnap = await getDoc(docRef);
                return docSnap.exists() ? docSnap.data() : {};
            } catch (error) {
                return null;
            }
        }

        // Generalized function to save data
        async function saveDocumentData(collectionPath, docId, data) {
            if (!isAuthReady || !db) return false;
            const docRef = doc(db, collectionPath, docId);
            try {
                await setDoc(docRef, data, { merge: true });
                return true;
            } catch (error) {
                console.error("Error saving document data:", collectionPath, docId, error);
                return false;
            }
        }

        // Specific implementation for User Profile (Identity)
        async function getUserProfile() {
             if (!appId || !userId) return { statement: "" };

             const collectionPath = `/artifacts/${appId}/users/${userId}/profileData`;
             const data = await getDocumentData(collectionPath, 'mainProfile');
             return data || { statement: "" };
        }

        async function saveUserProfile(data) {
            if (!appId || !userId) return false;
            const collectionPath = `/artifacts/${appId}/users/${userId}/profileData`;
            return await saveDocumentData(collectionPath, 'mainProfile', data);
        }


        // Specific implementation for Daily Data
        async function getDataForDate(date) {
            if (!appId || !userId) return null;

            const dateString = toISODateString(date);
            const collectionPath = `/artifacts/${appId}/users/${userId}/dailyData`;
            const data = await getDocumentData(collectionPath, dateString);

            // Define defaults for Execution List (4 stages) - LOCKED
            const defaultPowerList = [
                { text: "Stage 1: SCRIPTING the Doctrine", completed: false },
                { text: "Stage 2: RECORDING the Doctrine", completed: false },
                { text: "Stage 3: EDITING the Doctrine", completed: false },
                { text: "Stage 4: DEPLOYMENT (Publishing)", completed: false }
            ];

            const defaultReflection = { wins: "", lessons: "", identity: "" };
            const defaultCrucible = { text: "", completed: false };

            if (data && Object.keys(data).length > 0) {
                // Data sanitization and defaults
                let powerList = data.powerList;
                // Ensure the list structure is maintained and synchronized with the definitions
                 if (!Array.isArray(powerList) || powerList.length !== 4) {
                          powerList = defaultPowerList;
                     } else {
                     // Ensure the text labels are locked to the stages
                     powerList = defaultPowerList.map((defaultItem, index) => ({
                          text: defaultItem.text,
                          completed: powerList[index]?.completed || false
                     }));
                     }
                
                const reflection = (typeof data.reflection === 'object' && data.reflection !== null) ? { ...defaultReflection, ...data.reflection } : defaultReflection;
                const crucible = (typeof data.crucible === 'object' && data.crucible !== null) ? { ...defaultCrucible, ...data.crucible } : defaultCrucible;
               

                return {
                    checkedTasks: data.checkedTasks || [],
                    powerList: powerList,
                    reflection: reflection,
                    crucible: crucible,
                    // Workout logs are kept for historical data access, but not actively used for today's view in Trivialities
                    workoutLog: data.workoutLog || {},
                    completedSets: data.completedSets || {},
                    waterIntake: data.waterIntake || 0,
                };
            } else {
                // Return defaults if no document exists
                return { checkedTasks: [], powerList: defaultPowerList, reflection: defaultReflection, crucible: defaultCrucible, workoutLog: {}, completedSets: {}, waterIntake: 0};
            }
        }

        async function saveDataForDate(date, data) {
            if (!appId || !userId) return;

            const dateString = toISODateString(date);
            const collectionPath = `/artifacts/${appId}/users/${userId}/dailyData`;
            
            // Ensure any deprecated fields from previous versions (e.g., 'workout') are excluded if they exist in the data object
            const { workout, ...dataToSave } = data;
            
            await saveDocumentData(collectionPath, dateString, dataToSave);
        }


        // --- UI RENDERING ---
        async function renderUIForDate(date) {
            if (!isAuthReady) return;

            document.getElementById('loading-overlay').classList.remove('hidden');
           
            const today = new Date();
            // Normalize dates for comparison
            const todayNormalized = new Date(today.getFullYear(), today.getMonth(), today.getDate());
            const dateNormalized = new Date(date.getFullYear(), date.getMonth(), date.getDate());


            const isToday = dateNormalized.getTime() === todayNormalized.getTime();

             if (dateNormalized.getTime() > todayNormalized.getTime()) {
                 displayedDate = new Date();
                 date = displayedDate;
            }

            document.getElementById('current-date').textContent = date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
           
            document.getElementById('next-day-btn').disabled = isToday || dateNormalized.getTime() >= todayNormalized.getTime();
            document.getElementById('today-btn').classList.toggle('hidden', isToday);
            
            try {
                // Fetch necessary data first
                const [dailyData, profileData] = await Promise.all([
                    getDataForDate(date),
                    getUserProfile()
                ]);
               
                // Run rendering functions concurrently
                const results = await Promise.allSettled([
                    renderSchedule(date, dailyData),
                    renderPowerList(date, dailyData),
                    renderTrivialities(date, dailyData, profileData),
                    updateStreakDisplay(), // Fetches its own data iteratively
                    renderAudit(date, dailyData)
                ]);

                results.forEach(result => {
                    if(result.status === 'rejected') {
                        console.error("A rendering function failed:", result.reason);
                    }
                });
            } catch (error) {
                console.error("Error during data fetching or rendering process:", error);
            } finally {
                document.getElementById('loading-overlay').classList.add('hidden');
            }

            updateCurrentTaskHighlight(date);
            setDailyQuote(date);
        }

         // Render Trivialities (Vessel) Tab
        async function renderTrivialities(date, dailyData, profileData) {
            try {
                // 1. Render Identity (Profile Data)
                if (profileData && document.getElementById('identity-statement')) {
                    document.getElementById('identity-statement').value = profileData.statement || "";
                }

                // 2. Render Water Intake
                if (dailyData && document.getElementById('water-intake-display')) {
                    updateWaterDisplay(dailyData.waterIntake);
                }

                // 3. Render Workout Preview (For Tomorrow)
                // Check if the tab is currently visible (Performance optimization)
                const trivialitiesTabContent = document.getElementById('trivialities-content');
                if (!trivialitiesTabContent || trivialitiesTabContent.classList.contains('hidden')) {
                     return;
                }
                // Calculate tomorrow's date based on the currently displayed date
                const tomorrowDate = new Date(date.getTime());
                tomorrowDate.setDate(tomorrowDate.getDate() + 1);
                renderWorkoutPreview(tomorrowDate);


            } catch (error) {
                console.error("Error rendering Trivialities tab", error);
            }
        }

        // Update Water Display
        function updateWaterDisplay(count) {
            const display = document.getElementById('water-intake-display');
            if (display) {
                display.textContent = `${count} / 8`;
            }
        }


        // Render Workout Preview (Modified to show the plan without logging)
        async function renderWorkoutPreview(date) {
             const workoutLogContainer = document.getElementById('workout-log-container');
             if (!workoutLogContainer) return;

             try {
                 const workoutDayKey = getWorkoutDayKey(date);
                 const workoutForDay = workoutData.find(w => w.key === workoutDayKey);

                 if (!workoutForDay) {
                     workoutLogContainer.innerHTML = `<div class="bg-gray-800 p-5 rounded-lg text-center text-gray-400">Error determining workout.</div>`;
                     return;
                 }

                 // Render the workout plan without any logging inputs or checkboxes
                 workoutLogContainer.innerHTML = `
                     <div class="p-5 rounded-lg">
                         <h3 class="font-bold text-xl text-red-600 mb-3">${workoutForDay.title}</h3>
                         <p class="text-gray-400 mb-5">${workoutForDay.focus}</p>
                         <ul class="space-y-6">${workoutForDay.exercises.map(ex => {
                             return `
                             <li class="border-t border-gray-700 pt-6">
                                 <div>
                                     <p class="font-bold text-lg text-gray-100">${ex.name}</p>
                                     <p class="text-sm text-gray-400">${ex.details}</p>
                                 </div>
                             </li>`;
                         }).join('')}</ul>
                         <p class="mt-6 text-sm text-amber-500 italic"><span class="font-bold">Note:</span> ${workoutForDay.note}</p>
                     </div>`;
             } catch(error) {
                 console.error("Error rendering workout preview", error);
                 workoutLogContainer.innerHTML = `<div class="text-red-600">Error loading workout preview.</div>`;
             }
        }


         // Render Audit (Confrontation) Tab
        async function renderAudit(date, dailyData) {
            try {
                if (!dailyData) return;

                // 1. Render Reflections (Daily Data)
                if (document.getElementById('reflection-wins')) {
                    document.getElementById('reflection-wins').value = dailyData.reflection.wins || "";
                    document.getElementById('reflection-lessons').value = dailyData.reflection.lessons || "";
                    document.getElementById('reflection-identity').value = dailyData.reflection.identity || "";
                }

                // 2. Render The Exposure (Crucible)
                if (document.getElementById('crucible-container')) {
                    document.getElementById('crucible-container').innerHTML = `
                        <div class="flex items-center space-x-3">
                            <span class="text-gray-400">Link to deployed work (if applicable):</span>
                            <input type="text" id="crucible-input" class="app-input strategy-focus flex-1 rounded-md p-2" placeholder="Paste URL or N/A" value="${dailyData.crucible.text || ''}">
                            <input type="checkbox" id="crucible-checkbox" class="app-checkbox" ${dailyData.crucible.completed ? 'checked' : ''}>
                        </div>`;
                }

            } catch (error) {
                console.error("Error rendering Audit tab", error);
                const auditContent = document.getElementById('audit-content');
                if (auditContent) {
                    auditContent.innerHTML = `<div class="text-red-600">Error loading data.</div>`;
                }
            }
        }


        async function renderSchedule(date, dailyData) {
            const scheduleContainer = document.getElementById('schedule-container');
            if (!scheduleContainer) return;

            try {
                const dayKey = getDayKeyForDate(date);
                const schedule = schedules[dayKey];
               
                if (!dailyData || !schedule) return;

                const dayContainer = document.createElement('div');
                dayContainer.className = 'space-y-3';
                dayContainer.innerHTML = schedule.map((item, index) => `
                    <div id="task-${dayKey}-${index}" class="task-item flex items-center bg-gray-800 p-4 rounded-lg shadow-md">
                        <div class="w-1/4 sm:w-1/5"><p class="font-mono text-red-600">${item.time}</p></div>
                        <div class="flex-1">
                            <p class="font-semibold text-gray-100">${item.task}</p>
                            <p class="text-sm text-gray-400 mt-1">${item.details}</p>
                        </div>
                        <input type="checkbox" data-task-id="${index}" class="schedule-checkbox app-checkbox ml-4 flex-shrink-0" ${dailyData.checkedTasks.includes(index) ? 'checked' : ''}>
                    </div>`).join('');
                
                scheduleContainer.innerHTML = '';
                scheduleContainer.appendChild(dayContainer);
            } catch (error) {
                console.error("Error in renderSchedule:", error);
                scheduleContainer.innerHTML = `<div class="text-red-600">Error loading schedule.</div>`;
            }
        }
        
        // Enhanced Power List (Execution List) Renderer
        async function renderPowerList(date, dailyData) {
            const powerlistContainer = document.getElementById('powerlist-container');
            if (!powerlistContainer) return;

           try {
                if (!dailyData || !dailyData.powerList) return;
                
                powerlistContainer.innerHTML = dailyData.powerList.map((task, i) => {
                    return `
                        <div class="flex items-center bg-gray-800 p-4 rounded-lg">
                            <span class="text-amber-600 font-bold mr-4">${i + 1}.</span>
                                                                    <p class="flex-1 text-white">${task.text}</p>
                            <input type="checkbox" class="powerlist-checkbox app-checkbox grind-check ml-4" data-index="${i}" ${task.completed ? 'checked' : ''}>
                        </div>`;
                }).join('');
            } catch(error) {
                console.error("Error rendering execution list", error);
                powerlistContainer.innerHTML = `<div class="text-red-600">Error loading execution list.</div>`
            }
        }

        function updateCurrentTaskHighlight(date) {
            document.querySelectorAll('.task-item.task-current').forEach(item => item.classList.remove('task-current'));
           
            if (toISODateString(date) !== toISODateString(new Date())) return;
            
            const dayKey = getDayKeyForDate(date);

            const now = new Date();
            const currentTime = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
            const todaySchedule = schedules[dayKey];
           
            if (!todaySchedule) return;
           
            const currentTaskIndex = todaySchedule.findLastIndex(task => currentTime >= task.time);
           
            if (currentTaskIndex !== -1) {
                const taskElement = document.getElementById(`task-${dayKey}-${currentTaskIndex}`);
                if (taskElement) {
                    taskElement.classList.add('task-current');
                }
            }
        }
        
        function setDailyQuote(date) {
            // Use a hash of the date string to get a consistent index
            const dateString = toISODateString(date);
            let hash = 0;
            for (let i = 0; i < dateString.length; i++) {
                const char = dateString.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32bit integer
            }
            const index = Math.abs(hash) % quotes.length;
            const quote = quotes[index];
            const dailyQuoteElement = document.getElementById('daily-quote');
            if (dailyQuoteElement) {
                dailyQuoteElement.innerHTML = `<em>"${quote.text}"</em><br>- ${quote.author}`;
            }
        }


        // !! Optimization Note: This function remains potentially slow due to iterative DB fetches.
        async function updateStreakDisplay() {
            if (!isAuthReady) return;

            const streakCounter = document.getElementById('streak-counter');
            if (!streakCounter) return;

            // Start checking from yesterday
            const checkDate = new Date();
            checkDate.setHours(0, 0, 0, 0);
            checkDate.setDate(checkDate.getDate() - 1);
           
            let streak = 0;
           
            // Limit streak check for performance
            for (let i = 0; i < 100; i++) {
                const data = await getDataForDate(checkDate);
                // Check if data exists and all tasks in the powerList are completed
                if (data && Array.isArray(data.powerList) && data.powerList.length > 0 && data.powerList.every(task => task.completed)) {
                    streak++;
                    checkDate.setDate(checkDate.getDate() - 1);
                } else {
                    break; // Streak broken
                }
            }

            // Check today's completion
            const todayData = await getDataForDate(new Date());
            if (todayData && Array.isArray(todayData.powerList) && todayData.powerList.length > 0 && todayData.powerList.every(task => task.completed)) {
                streak++;
            }

            streakCounter.textContent = streak;
        }


        // --- EVENT HANDLERS ---

        // Debounced Save Handlers (500ms delay)
        const debouncedSaveDailyData = debounce(async (date, data) => {
            await saveDataForDate(date, data);
        }, 500);


        // Handle Reflection Input (Daily)
        function handleReflectionInput(e) {
            if (e.target.matches('.app-textarea') && e.target.closest('#audit-content')) {
                getDataForDate(displayedDate).then(data => {
                    if (data) {
                        const reflectionKey = e.target.id.split('-')[1];
                        if (!data.reflection) data.reflection = {};
                        data.reflection[reflectionKey] = e.target.value;
                        debouncedSaveDailyData(displayedDate, { reflection: data.reflection });
                    }
                });
            }
        }

        // Handle Daily Crucible (The Exposure) Change
        async function handleDailyCrucibleChange(e) {
            if (!e.target.closest('#audit-content')) return;

            const data = await getDataForDate(displayedDate);
            if (!data) return;

            if (!data.crucible) data.crucible = { text: "", completed: false };

            let needsSave = false;

            if (e.target.matches('#crucible-input')) {
                data.crucible.text = e.target.value;
                needsSave = true;
            }
            else if (e.target.matches('#crucible-checkbox')) {
                data.crucible.completed = e.target.checked;
                needsSave = true;
            }

            if (needsSave) {
                if (e.type === 'input') {
                    debouncedSaveDailyData(displayedDate, { crucible: data.crucible });
                } else {
                    saveDataForDate(displayedDate, { crucible: data.crucible });
                }
            }
        }


         // Handle Save Identity
        async function handleSaveIdentity() {
            const saveIdentityBtn = document.getElementById('save-identity-btn');
            const identitySaveStatus = document.getElementById('identity-save-status');
            if (!saveIdentityBtn || !identitySaveStatus) return;

            saveIdentityBtn.disabled = true;
            identitySaveStatus.textContent = "Locking...";
            const data = {
                statement: document.getElementById('identity-statement').value.trim(),
            };
            const success = await saveUserProfile(data);
            saveIdentityBtn.disabled = false;
            if (success) {
                identitySaveStatus.textContent = "Identity Locked.";
                setTimeout(() => {
                    if (identitySaveStatus) identitySaveStatus.textContent = "";
                }, 3000);
            } else {
                identitySaveStatus.textContent = "Error locking identity.";
            }
        }

        // Handle Water Intake
        async function handleWaterIntake(action) {
            const data = await getDataForDate(displayedDate);
            if (!data) return;

            if (action === 'increment') {
                data.waterIntake = (data.waterIntake || 0) + 1;
            } else if (action === 'reset') {
                data.waterIntake = 0;
            }
            
            updateWaterDisplay(data.waterIntake);
            // Immediate save for water intake
            saveDataForDate(displayedDate, { waterIntake: data.waterIntake });
        }


        function handleScheduleCheckboxChange(e) {
            if (e.target.matches('.schedule-checkbox')) {
                const taskId = parseInt(e.target.dataset.taskId);
                if (isNaN(taskId)) return;

                getDataForDate(displayedDate).then(data => {
                    if (!data) return;
                    const newCheckedTasks = new Set(data.checkedTasks);
                    e.target.checked ? newCheckedTasks.add(taskId) : newCheckedTasks.delete(taskId);
                    // Immediate save for checkboxes
                    saveDataForDate(displayedDate, { checkedTasks: Array.from(newCheckedTasks) });
                });
            }
        }

        function handlePowerListCheckChange(e) {
            if (e.target.matches('.powerlist-checkbox')) {
                const index = parseInt(e.target.dataset.index);
                if (isNaN(index)) return;

                getDataForDate(displayedDate).then(data => {
                    if (data && data.powerList && data.powerList[index]) {
                        data.powerList[index].completed = e.target.checked;
                        // Immediate save, then update streak
                        saveDataForDate(displayedDate, { powerList: data.powerList }).then(updateStreakDisplay);
                    }
                });
            }
        }

        // NOTE: Workout Event Handlers (handleWorkoutLogChange, handleWorkoutLogDelete, handleSetCheckboxChange) 
        // are removed as the Trivialities tab now only shows a preview of the next day's workout.

        

        // --- SETUP, UTILITY & TIMER ---
        function setupTabs() {
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => {
                tab.addEventListener('click', async () => {
                    tabs.forEach(t => t.classList.remove('tab-active'));
                    tab.classList.add('tab-active');
                    const target = tab.getAttribute('data-tab');
                    tabContents.forEach(content => {
                        content.id === `${target}-content` ? content.classList.remove('hidden') : content.classList.add('hidden');
                    });

                    // If switching to Trivialities tab, ensure data is fresh
                     if (target === 'trivialities' && isAuthReady) {
                         const todayData = await getDataForDate(displayedDate);
                         const profileData = await getUserProfile();
                         // Ensure Trivialities rendering is triggered when the tab is activated
                         renderTrivialities(displayedDate, todayData, profileData);
                     }
                });
            });
            // Default to The Grind
            document.querySelector('[data-tab="grind"]').click();
        }
        
        function updateTime() {
            const currentTimeEl = document.getElementById('current-time');
            const now = new Date();
            const options = {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false,
            };
            if (currentTimeEl) {
                try {
                     // Using 'en-GB' ensures 24-hour format (HH:MM:SS)
                    currentTimeEl.textContent = now.toLocaleTimeString('en-GB', options);
                } catch (error) {
                    currentTimeEl.textContent = now.toTimeString().split(' ')[0];
                }
            }
        }


        // --- MAIN INITIALIZATION (DOMContentLoaded) ---
        document.addEventListener('DOMContentLoaded', async () => {
            
            // Firebase Initialization
            let firebaseConfig;
            let initialAuthToken;
           
            // Check for injected variables (Canvas environment compatibility)
            const getGlobalVar = (varName) => {
                if (typeof window !== 'undefined' && typeof window[varName] !== 'undefined' && window[varName].trim() !== '') {
                    return window[varName];
                }
                if (typeof self !== 'undefined' && typeof self[varName] !== 'undefined' && self[varName].trim() !== '') {
                    return self[varName];
                }
                try {
                    if (typeof eval(varName) !== 'undefined') return eval(varName);
                } catch (e) {}
                return null;
            };

            const firebaseConfigStr = getGlobalVar('__firebase_config');

            if (firebaseConfigStr) {
                try {
                    firebaseConfig = JSON.parse(firebaseConfigStr);
                    initialAuthToken = getGlobalVar('__initial_auth_token');
                    appId = getGlobalVar('__app_id') || 'default-app-id';
                } catch (e) {
                    console.error("Canvas Firebase config error", e);
                }
            }
            
            // Fallback configuration (Local Development/External Hosting)
            if (!firebaseConfig) {
                // !! IMPORTANT !! Replace with your own Firebase Config if hosting elsewhere.
                firebaseConfig = { apiKey: "AIzaSyC0eAiglVV-ucbsNeC1UmnNs_xxa-hgOh4", authDomain: "hanuzzi.firebaseapp.com", projectId: "hanuzzi", storageBucket: "hanuzzi.appspot.com", messagingSenderId: "223419940249", appId: "1:223419940249:web:a5b346892e67d6df312708" };
                appId = firebaseConfig.appId || 'default-local-app';
            }
            
            // Robust initialization check
            if (!firebaseConfig || !firebaseConfig.apiKey) {
                console.error("Firebase configuration not found or incomplete.");
                const mainContent = document.getElementById('main-content');
                 if (mainContent) {
                     mainContent.innerHTML = `<div class="text-red-600 text-center p-8">Configuration Error. The application cannot load.</div>`;
                }
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                const mainContent = document.getElementById('main-content');
                 if (mainContent) {
                     mainContent.innerHTML = `<div class="text-red-600 text-center p-8">Initialization failed. Check console for errors.</div>`;
                }
                return;
            }


            // Authentication State Listener
            onAuthStateChanged(auth, user => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    // Initialize UI once authentication is confirmed
                    renderUIForDate(displayedDate).catch(err => {
                        console.error("Critical rendering error:", err);
                        const mainContent = document.getElementById('main-content');
                        if (mainContent) {
                             mainContent.innerHTML = `<div class="text-red-600 text-center p-8">A critical error occurred during rendering. Please refresh the page.</div>`;
                        }
                    });
                } else {
                    isAuthReady = false;
                }
            });
            
            // Perform Sign-in
            if (!auth.currentUser) {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    }
                    else {
                        // Anonymous auth for environments without custom tokens
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Authentication failed:", error);
                    document.body.innerHTML = '<div class="text-red-600 text-center p-8">Authentication failed. Please refresh.</div>';
                    return;
                }
            }


            // --- SETUP LISTENERS ONCE ---
            setupTabs();
            
            // Event Delegation Setup
            const mainContent = document.getElementById('main-content');
            const scheduleContainer = document.getElementById('schedule-container');
            const powerlistContainer = document.getElementById('powerlist-container');
            const workoutLogContainer = document.getElementById('workout-log-container');


            // Audit/Confrontation Handlers
            if (mainContent) {
                mainContent.addEventListener('input', handleReflectionInput);
                mainContent.addEventListener('input', handleDailyCrucibleChange);
                mainContent.addEventListener('change', handleDailyCrucibleChange);
            }

            // Power/Execution List Handlers
            if (powerlistContainer) {
                powerlistContainer.addEventListener('change', (e) => {
                    if (e.target.matches('.powerlist-checkbox')) {
                        handlePowerListCheckChange(e);
                    }
                });
            }


            // Identity Handler (Trivialities Tab)
            const saveIdentityBtn = document.getElementById('save-identity-btn');
            if (saveIdentityBtn) {
                saveIdentityBtn.addEventListener('click', handleSaveIdentity);
            }

            // Water Intake Handlers (Trivialities Tab)
            const incrementWaterBtn = document.getElementById('increment-water-btn');
            if (incrementWaterBtn) {
                incrementWaterBtn.addEventListener('click', () => handleWaterIntake('increment'));
            }
            const resetWaterBtn = document.getElementById('reset-water-btn');
            if (resetWaterBtn) {
                resetWaterBtn.addEventListener('click', () => handleWaterIntake('reset'));
            }


            // Schedule Handlers (Grind Tab)
            if (scheduleContainer) {
                scheduleContainer.addEventListener('change', handleScheduleCheckboxChange);
            }

            // NOTE: Workout Handlers are removed from delegation as the Trivialities tab is now a preview.


            // Date Navigation
            document.getElementById('today-btn')?.addEventListener('click', () => { 
                displayedDate = new Date(); 
                renderUIForDate(displayedDate); 
            });
           
            document.getElementById('prev-day-btn')?.addEventListener('click', () => { 
                const newDate = new Date(displayedDate);
                newDate.setDate(newDate.getDate() - 1);
                displayedDate = newDate;
                renderUIForDate(displayedDate); 
            });
           
            document.getElementById('next-day-btn')?.addEventListener('click', () => {
                const today = new Date();
                const nextDay = new Date(displayedDate);
                nextDay.setDate(nextDay.getDate() + 1);

                // Use normalized comparison to prevent future navigation
                const todayNorm = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                const nextDayNorm = new Date(nextDay.getFullYear(), nextDay.getMonth(), nextDay.getDate());

                if (nextDayNorm.getTime() <= todayNorm.getTime()) {
                    displayedDate = nextDay;
                    renderUIForDate(displayedDate);
                }
            });
            

            // --- SETUP TIMERS ---
            updateTime();
            setInterval(updateTime, 1000);
            // Update task highlight every minute
            setInterval(() => updateCurrentTaskHighlight(new Date()), 60000); 
        });

    </script>
</body>
</html>